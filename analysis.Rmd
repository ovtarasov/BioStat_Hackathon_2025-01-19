---
title: "Hackathon"
author: "Group2"
date: "2025-01-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(flextable)

```

## Загрузка данных

```{r read-data}
data_team_02 <- read_csv("Data/team_2.csv")

```

## Преобразование данных в человекочитаемый вид

```{r}
# Преобразование данных в человекочитаемый вид

cleaned_data_team_02 <- data_team_02 %>%
  mutate(
    # Преобразование категориальных переменных в факторы 
    across(contains("GRP"), ~ factor(., levels = c("T", "R"), labels = c("Treatment", "Comparator"))),
    across(contains("GEN"), ~ factor(., levels = c(1, 0), labels = c("Male", "Female"))),
    across(contains("_NORM_"), ~ factor(., levels = c(0, 1, 2), labels = c("Normal", "Mild deviation", "Significant deviation")))
  )%>%
  rename_with(~ str_replace_all(., c(
    "V(\\d+)_GRP" = "Group",
    "V(\\d+)_DEM_GEN" = "Gender",
    "V(\\d+)_DEM_AGE" = "Age",
    "V(\\d+)_CB_WBC" = "White_Blood_Cells_\\1",
    "V(\\d+)_CB_RBC" = "Red_Blood_Cells_\\1",
    "V(\\d+)_CB_HGB" = "Hemoglobin_\\1",
    "V(\\d+)_CB_HCT" = "Hematocrit_\\1",
    "V(\\d+)_CB_PLT" = "Platelets_\\1",
    "V(\\d+)_CB_NEUT#" = "Neutrophils_\\1",
    "V(\\d+)_CB_LYM#" = "Lymphocytes_\\1",
    "V(\\d+)_CB_MON#" = "Monocytes_\\1",
    "V(\\d+)_CB_EO#" = "Eosinophils_\\1",
    "V(\\d+)_CB_BAS#" = "Basophils_\\1",
    "V(\\d+)_NORM_ECG" = "ECG_Status_\\1",
    "V(\\d+)_NORM_PHYS" = "Physical_Status_\\1",
    "V(\\d+)_RMDQ" = "RMDQ_Score_\\1",
    "V(\\d+)_NORM_VIT" = "Vital_Status_\\1"
  )), .cols = everything()) 

```
## Проверка данных

```{r check-data, include = FALSE}

sum(is.na(data_team_02))
sum(is.na(cleaned_data_team_02))
# glimpse(cleaned_data_team_02)
summary(cleaned_data_team_02)
str(cleaned_data_team_02)

```
Пропущенных значений нет

## Создание функции для расчета статистик

```{r descriptive-stat-function}
statistics_dbl <- list(
  
  # Количество значений
  `__Количество значений` = ~ length(.x) %>% as.character(),

  # Среднее значение (если нет значений, возвращает "Н/П*")
  `__Ср. знач.` = ~ ifelse(
    sum(!is.na(.x)) == 0,
    "Н/П*",
    mean(.x, na.rm = TRUE) %>% round(2) %>% as.character()
  ),

  # 95% ДИ (если нет значений, возвращает "Н/П*")
  `__95% ДИ` = ~ ifelse(
    sum(!is.na(.x)) == 0,
    "Н/П*",
    paste0(
      t.test(.x)$conf.int[1] %>% round(2),
      "   ",
      t.test(.x)$conf.int[2] %>% round(2)
    ) %>% as.character()
  ),

  # Коэффициент вариации 
  `__Коэф. вариации` = ~ ifelse(
    sum(!is.na(.x)) < 2,  # Изменено условие для обработки недостаточных значений
    "Н/П*",
    (sd(.x, na.rm = TRUE) / mean(.x, na.rm = TRUE)) %>% round(2) %>% as.character()
  ),

  # Стандартное отклонение (если менее 3 значений, возвращает "Н/П*")
  `__Станд. отклон.` = ~ ifelse(
    sum(!is.na(.x)) < 3,
    "Н/П*",
    sd(.x, na.rm = TRUE) %>% round(2) %>% as.character()
  ),

  # Медиана (если нет значений, возвращает "Н/П*")
  `__Медиана` = ~ ifelse(
    sum(!is.na(.x)) == 0,
    "Н/П*",
    median(.x, na.rm = TRUE) %>% round(2) %>% as.character()
  ),

  # Межквартильный размах (если нет значений, возвращает "Н/П*")
  `__IQR` = ~ ifelse( 
    sum(!is.na(.x)) == 0,
    "Н/П*",
    IQR(.x, na.rm = TRUE) %>% round(2) %>% as.character()
  ),

  # Минимум (если нет значений, возвращает "Н/П*")
  `__минимум` = ~ ifelse(
    sum(!is.na(.x)) == 0,
    "Н/П*",
    min(.x, na.rm = TRUE) %>% round(2) %>% as.character()
  ),

  # Максимум (если нет значений, возвращает "Н/П*")
  `__максимум` = ~ ifelse(
    sum(!is.na(.x)) == 0,
    "Н/П*",
    max(.x, na.rm = TRUE) %>% round(2) %>% as.character()
  )
)
```


## Расчет описательных статистик и формирование таблицы

```{r descriptive-stat-table}
#  Теперь выберем переменные которые будем считать 
 data_team_02 %>%
  select(V0_DEM_GEN, V0_GRP, where(is.numeric)) %>%
   # сгруппируем по  V0_GRP
  group_by(V0_GRP) %>% 
   # добавим статистик
  summarize(across(where(is.numeric), statistics_dbl )) %>% 
   # сделаем таблицу в длинном формате 
  pivot_longer(!V0_GRP) %>% 
  separate(name, into=c("Переменная", "Статистика"), sep= "___") ->a1
 
 a1 %>%
  flextable() %>% 
  theme_box() %>% 
  align(align = "center", part = "all") %>% 
  merge_v(c("V0_GRP", "Переменная"))  


```

```{r warning=FALSE}
# Сабсет для первого визита
cleaned_data_team_02_1 <- cleaned_data_team_02 %>% select(-contains("_2"), -contains("_3"))

# Подсчет количества наблюдений в каждой группе
group_counts <- cleaned_data_team_02_1 %>%
  count(Group)
print(group_counts)

# Сравнение количественных переменных (t-тест Стьюдента)
numerical_data_team_02 <- cleaned_data_team_02_1 %>% select(where(is.numeric))
numerical_results <- map_df(names(numerical_data_team_02), ~ {
  t_test <- t.test(numerical_data_team_02[[.x]] ~ cleaned_data_team_02_1$Group)
  tibble(
    variable = .x,
    p_value = t_test$p.value,
    method = "t-test"
  )
})

# Сравнение категориальных переменных (χ2-критерий Пирсона)
categorical_data_team_02 <- cleaned_data_team_02_1 %>% select(where(~ !is.numeric(.x)))
categorical_results <- map_df(names(categorical_data_team_02), ~ {
  tbl <- table(categorical_data_team_02[[.x]], cleaned_data_team_02_1$Group)
  p_val <- chisq.test(tbl)$p.value
  tibble(
    variable = .x,
    p_value = p_val,
    method = "Chi-squared test"
  )
})


comparison_results %>% 
  arrange(p_value) %>% 
  print()
```

```{r}
# Создание боксплотов для RMDQ_Score_1 и Age
ggplot(cleaned_data_team_02_1, aes(x = Group, y = RMDQ_Score_1, fill = Group)) +
  geom_boxplot() +
  labs(title = "Сравнимость групп по опросникуРОЛАНДА МОРРИСА", x = "Group", y = "RMDQ Score") +
  theme_minimal()

ggplot(cleaned_data_team_02_1, aes(x = Group, y = Age, fill = Group)) +
  geom_boxplot() +
  labs(title = "Сравнимость групп по возрасту", x = "Group", y = "Age") +
  theme_minimal()
```

**Вывод**
На основании предоставленных данных, группы имеют равное количество участников (387 в каждой). Для всех переменных различий между группами не обнаружено даже без поправки на множественные сравнения (FDR), что подтверждает их сопоставимость для дальнейшего анализа.

---

# Анализ первичной конечной точки

```{r effectiveness}



```
